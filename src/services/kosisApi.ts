import axios from 'axios';

// 환경변수에서 API 키 가져오기
const API_KEY = process.env.REACT_APP_KOSIS_API_KEY || 'MGJiMDhhOTE1MmFkY2I4MThlNThmOGMxNzMyMjBjZDM=';
const BASE_URL = 'https://kosis.kr/openapi/Param/statisticsParameterData.do';

export interface WageSearchParams {
  지역?: string;
  직종?: string;
  년도?: string;
}

export interface KosisApiResponse {
  [key: string]: any;
}

// KOSIS API 호출 함수
export const fetchWageData = async (params: WageSearchParams) => {
  try {
    const response = await axios.get(BASE_URL, {
      params: {
        method: 'getList',
        apiKey: API_KEY,
        itmId: 'T10+T20+T30+T40', // 직종별 항목
        objL1: '47', // 시도별
        objL2: 'ALL', // 전체
        format: 'json',
        jsonVD: 'Y',
        prdSe: 'M', // 월별
        newEstPrdCnt: '12', // 최근 12개월
        orgId: '365',
        tblId: 'TX_36504_A001_1',
        ...params
      }
    });

    // API 응답 데이터 처리
    if (response.data && response.data.length > 0) {
      return response.data.map((item: any) => ({
        직종: item.C1_NM || '정보없음',
        지역: item.C2_NM || '전국',
        단가: parseInt(item.DT) || 0,
        기준일: item.PRD_DE || '정보없음'
      }));
    }
    
    return [];
  } catch (error) {
    console.error('KOSIS API 호출 오류:', error);
    
    // 실제 노임단가 데이터 (2025년 하반기)
    const wageData2025_2 = [
      { 직종: '작업반장', 단가: 214661, 기준일: '2025-02', 코드: '1001' },
      { 직종: '보통인부', 단가: 171037, 기준일: '2025-02', 코드: '1002' },
      { 직종: '특별인부', 단가: 224490, 기준일: '2025-02', 코드: '1003' },
      { 직종: '조력공', 단가: 179958, 기준일: '2025-02', 코드: '1004' },
      { 직종: '제도사', 단가: 239200, 기준일: '2025-02', 코드: '1005' },
      { 직종: '비계공', 단가: 279613, 기준일: '2025-02', 코드: '1006' },
      { 직종: '형틀목공', 단가: 273074, 기준일: '2025-02', 코드: '1007' },
      { 직종: '철근공', 단가: 265818, 기준일: '2025-02', 코드: '1008' },
      { 직종: '철공', 단가: 237686, 기준일: '2025-02', 코드: '1009' },
      { 직종: '철판공', 단가: 219862, 기준일: '2025-02', 코드: '1010' },
      { 직종: '철골공', 단가: 251511, 기준일: '2025-02', 코드: '1011' },
      { 직종: '용접공', 단가: 280178, 기준일: '2025-02', 코드: '1012' },
      { 직종: '콘크리트공', 단가: 271064, 기준일: '2025-02', 코드: '1013' },
      { 직종: '보링공', 단가: 226520, 기준일: '2025-02', 코드: '1014' },
      { 직종: '착암공', 단가: 220354, 기준일: '2025-02', 코드: '1015' },
      { 직종: '화약취급공', 단가: 261462, 기준일: '2025-02', 코드: '1016' },
      { 직종: '할석공', 단가: 240163, 기준일: '2025-02', 코드: '1017' },
      { 직종: '포설공', 단가: 219579, 기준일: '2025-02', 코드: '1018' },
      { 직종: '포장공', 단가: 270747, 기준일: '2025-02', 코드: '1019' },
      { 직종: '잠수부', 단가: 392061, 기준일: '2025-02', 코드: '1020' },
      { 직종: '조적공', 단가: 275141, 기준일: '2025-02', 코드: '1021' },
      { 직종: '견출공', 단가: 247938, 기준일: '2025-02', 코드: '1022' },
      { 직종: '건축목공', 단가: 283068, 기준일: '2025-02', 코드: '1023' },
      { 직종: '창호공', 단가: 250287, 기준일: '2025-02', 코드: '1024' },
      { 직종: '유리공', 단가: 250389, 기준일: '2025-02', 코드: '1025' },
      { 직종: '방수공', 단가: 226204, 기준일: '2025-02', 코드: '1026' },
      { 직종: '미장공', 단가: 278998, 기준일: '2025-02', 코드: '1027' },
      { 직종: '타일공', 단가: 286589, 기준일: '2025-02', 코드: '1028' },
      { 직종: '도장공', 단가: 258362, 기준일: '2025-02', 코드: '1029' },
      { 직종: '내장공', 단가: 255231, 기준일: '2025-02', 코드: '1030' },
      { 직종: '도배공', 단가: 226042, 기준일: '2025-02', 코드: '1031' },
      { 직종: '연마공', 단가: 210772, 기준일: '2025-02', 코드: '1032' },
      { 직종: '석공', 단가: 267532, 기준일: '2025-02', 코드: '1033' },
      { 직종: '줄눈공', 단가: 207796, 기준일: '2025-02', 코드: '1034' },
      { 직종: '판넬조립공', 단가: 240735, 기준일: '2025-02', 코드: '1035' },
      { 직종: '지붕잇기공', 단가: 229958, 기준일: '2025-02', 코드: '1036' },
      { 직종: '벌목부', 단가: 248140, 기준일: '2025-02', 코드: '1037' },
      { 직종: '조경공', 단가: 227176, 기준일: '2025-02', 코드: '1038' },
      { 직종: '배관공', 단가: 239439, 기준일: '2025-02', 코드: '1039' },
      { 직종: '배관공(수도)', 단가: 257390, 기준일: '2025-02', 코드: '1040' },
      { 직종: '위생공', 단가: 220650, 기준일: '2025-02', 코드: '1042' },
      { 직종: '덕트공', 단가: 205696, 기준일: '2025-02', 코드: '1043' },
      { 직종: '보온공', 단가: 214975, 기준일: '2025-02', 코드: '1044' },
      { 직종: '인력운반공', 단가: 181753, 기준일: '2025-02', 코드: '1045' },
      { 직종: '건설기계운전사', 단가: 279824, 기준일: '2025-02', 코드: '1048' },
      { 직종: '화물차운전사', 단가: 240685, 기준일: '2025-02', 코드: '1049' },
      { 직종: '일반기계운전사', 단가: 172387, 기준일: '2025-02', 코드: '1050' },
      { 직종: '기계설비공', 단가: 241550, 기준일: '2025-02', 코드: '1051' },
      { 직종: '플랜트배관공', 단가: 324800, 기준일: '2025-02', 코드: '1056' },
      { 직종: '플랜트제관공', 단가: 260644, 기준일: '2025-02', 코드: '1057' },
      { 직종: '플랜트용접공', 단가: 301090, 기준일: '2025-02', 코드: '1058' },
      { 직종: '플랜트특수용접공', 단가: 337247, 기준일: '2025-02', 코드: '1059' },
      { 직종: '플랜트기계설치공', 단가: 238846, 기준일: '2025-02', 코드: '1060' },
      { 직종: '플랜트특별인부', 단가: 220283, 기준일: '2025-02', 코드: '1061' },
      { 직종: '플랜트케이블전공', 단가: 262679, 기준일: '2025-02', 코드: '1062' },
      { 직종: '플랜트계장공', 단가: 202691, 기준일: '2025-02', 코드: '1063' },
      { 직종: '플랜트보온공', 단가: 247756, 기준일: '2025-02', 코드: '1065' },
      { 직종: '제철축로공', 단가: 358786, 기준일: '2025-02', 코드: '1066' },
      { 직종: '비파괴시험공', 단가: 216404, 기준일: '2025-02', 코드: '1067' },
      { 직종: '내선전공', 단가: 273539, 기준일: '2025-02', 코드: '1075' },
      { 직종: '특고압케이블전공', 단가: 439248, 기준일: '2025-02', 코드: '1076' },
      { 직종: '고압케이블전공', 단가: 372997, 기준일: '2025-02', 코드: '1077' },
      { 직종: '저압케이블전공', 단가: 303632, 기준일: '2025-02', 코드: '1078' },
      { 직종: '송전전공', 단가: 637453, 기준일: '2025-02', 코드: '1079' },
      { 직종: '송전활선전공', 단가: 673714, 기준일: '2025-02', 코드: '1080' },
      { 직종: '배전전공', 단가: 413173, 기준일: '2025-02', 코드: '1081' },
      { 직종: '배전활선전공', 단가: 560837, 기준일: '2025-02', 코드: '1082' },
      { 직종: '플랜트전공', 단가: 271800, 기준일: '2025-02', 코드: '1083' },
      { 직종: '계장공', 단가: 318902, 기준일: '2025-02', 코드: '1084' },
      { 직종: '철도신호공', 단가: 305348, 기준일: '2025-02', 코드: '1085' },
      { 직종: '통신내선공', 단가: 283607, 기준일: '2025-02', 코드: '1086' },
      { 직종: '통신설비공', 단가: 314787, 기준일: '2025-02', 코드: '1087' },
      { 직종: '통신외선공', 단가: 407342, 기준일: '2025-02', 코드: '1088' },
      { 직종: '통신케이블공', 단가: 440868, 기준일: '2025-02', 코드: '1089' },
      { 직종: '무선안테나공', 단가: 354977, 기준일: '2025-02', 코드: '1090' },
      { 직종: '석면해체공', 단가: 204762, 기준일: '2025-02', 코드: '1091' }
    ];

    // 2025년 상반기 데이터
    const wageData2025_1 = [
      { 직종: '작업반장', 단가: 213033, 기준일: '2025-01', 코드: '1001' },
      { 직종: '보통인부', 단가: 169804, 기준일: '2025-01', 코드: '1002' },
      { 직종: '특별인부', 단가: 221506, 기준일: '2025-01', 코드: '1003' },
      { 직종: '조력공', 단가: 180331, 기준일: '2025-01', 코드: '1004' },
      { 직종: '제도사', 단가: 232099, 기준일: '2025-01', 코드: '1005' },
      { 직종: '비계공', 단가: 279433, 기준일: '2025-01', 코드: '1006' },
      { 직종: '형틀목공', 단가: 272831, 기준일: '2025-01', 코드: '1007' },
      { 직종: '철근공', 단가: 264104, 기준일: '2025-01', 코드: '1008' },
      { 직종: '철공', 단가: 237754, 기준일: '2025-01', 코드: '1009' },
      { 직종: '철판공', 단가: 219236, 기준일: '2025-01', 코드: '1010' },
      { 직종: '철골공', 단가: 250239, 기준일: '2025-01', 코드: '1011' },
      { 직종: '용접공', 단가: 278326, 기준일: '2025-01', 코드: '1012' },
      { 직종: '콘크리트공', 단가: 266361, 기준일: '2025-01', 코드: '1013' },
      { 직종: '보링공', 단가: 225273, 기준일: '2025-01', 코드: '1014' },
      { 직종: '착암공', 단가: 220081, 기준일: '2025-01', 코드: '1015' },
      { 직종: '화약취급공', 단가: 258751, 기준일: '2025-01', 코드: '1016' },
      { 직종: '할석공', 단가: 236986, 기준일: '2025-01', 코드: '1017' },
      { 직종: '포설공', 단가: 216121, 기준일: '2025-01', 코드: '1018' },
      { 직종: '포장공', 단가: 267989, 기준일: '2025-01', 코드: '1019' },
      { 직종: '잠수부', 단가: 388892, 기준일: '2025-01', 코드: '1020' },
      { 직종: '조적공', 단가: 266624, 기준일: '2025-01', 코드: '1021' },
      { 직종: '견출공', 단가: 243075, 기준일: '2025-01', 코드: '1022' },
      { 직종: '건축목공', 단가: 277894, 기준일: '2025-01', 코드: '1023' },
      { 직종: '창호공', 단가: 248350, 기준일: '2025-01', 코드: '1024' },
      { 직종: '유리공', 단가: 248139, 기준일: '2025-01', 코드: '1025' },
      { 직종: '방수공', 단가: 220722, 기준일: '2025-01', 코드: '1026' },
      { 직종: '미장공', 단가: 272354, 기준일: '2025-01', 코드: '1027' },
      { 직종: '타일공', 단가: 284337, 기준일: '2025-01', 코드: '1028' },
      { 직종: '도장공', 단가: 253409, 기준일: '2025-01', 코드: '1029' },
      { 직종: '내장공', 단가: 252249, 기준일: '2025-01', 코드: '1030' },
      { 직종: '도배공', 단가: 222618, 기준일: '2025-01', 코드: '1031' },
      { 직종: '석공', 단가: 266246, 기준일: '2025-01', 코드: '1033' },
      { 직종: '줄눈공', 단가: 202696, 기준일: '2025-01', 코드: '1034' },
      { 직종: '판넬조립공', 단가: 237854, 기준일: '2025-01', 코드: '1035' },
      { 직종: '지붕잇기공', 단가: 224113, 기준일: '2025-01', 코드: '1036' },
      { 직종: '벌목부', 단가: 248681, 기준일: '2025-01', 코드: '1037' },
      { 직종: '조경공', 단가: 224132, 기준일: '2025-01', 코드: '1038' },
      { 직종: '배관공', 단가: 238145, 기준일: '2025-01', 코드: '1039' },
      { 직종: '배관공(수도)', 단가: 250572, 기준일: '2025-01', 코드: '1040' },
      { 직종: '보일러공', 단가: 233255, 기준일: '2025-01', 코드: '1041' },
      { 직종: '위생공', 단가: 219040, 기준일: '2025-01', 코드: '1042' },
      { 직종: '덕트공', 단가: 201482, 기준일: '2025-01', 코드: '1043' },
      { 직종: '보온공', 단가: 213722, 기준일: '2025-01', 코드: '1044' },
      { 직종: '인력운반공', 단가: 180404, 기준일: '2025-01', 코드: '1045' },
      { 직종: '건설기계조장', 단가: 202954, 기준일: '2025-01', 코드: '1047' },
      { 직종: '건설기계운전사', 단가: 273971, 기준일: '2025-01', 코드: '1048' },
      { 직종: '화물차운전사', 단가: 237500, 기준일: '2025-01', 코드: '1049' },
      { 직종: '일반기계운전사', 단가: 170920, 기준일: '2025-01', 코드: '1050' },
      { 직종: '기계설비공', 단가: 237652, 기준일: '2025-01', 코드: '1051' },
      { 직종: '플랜트배관공', 단가: 324130, 기준일: '2025-01', 코드: '1056' },
      { 직종: '플랜트제관공', 단가: 259128, 기준일: '2025-01', 코드: '1057' },
      { 직종: '플랜트용접공', 단가: 299776, 기준일: '2025-01', 코드: '1058' },
      { 직종: '플랜트기계설치공', 단가: 236640, 기준일: '2025-01', 코드: '1060' },
      { 직종: '플랜트특별인부', 단가: 218614, 기준일: '2025-01', 코드: '1061' },
      { 직종: '플랜트케이블전공', 단가: 261587, 기준일: '2025-01', 코드: '1062' },
      { 직종: '플랜트계장공', 단가: 202712, 기준일: '2025-01', 코드: '1063' },
      { 직종: '플랜트보온공', 단가: 247028, 기준일: '2025-01', 코드: '1065' },
      { 직종: '비파괴시험공', 단가: 217619, 기준일: '2025-01', 코드: '1067' },
      { 직종: '중급품질관리원', 단가: 172227, 기준일: '2025-01', 코드: '1070' },
      { 직종: '초급품질관리원', 단가: 144810, 기준일: '2025-01', 코드: '1071' },
      { 직종: '지적기사', 단가: 263991, 기준일: '2025-01', 코드: '1072' },
      { 직종: '지적산업기사', 단가: 236718, 기준일: '2025-01', 코드: '1073' },
      { 직종: '지적기능사', 단가: 181822, 기준일: '2025-01', 코드: '1074' },
      { 직종: '내선전공', 단가: 268915, 기준일: '2025-01', 코드: '1075' },
      { 직종: '특고압케이블전공', 단가: 436458, 기준일: '2025-01', 코드: '1076' },
      { 직종: '고압케이블전공', 단가: 370529, 기준일: '2025-01', 코드: '1077' },
      { 직종: '저압케이블전공', 단가: 300337, 기준일: '2025-01', 코드: '1078' },
      { 직종: '송전전공', 단가: 627960, 기준일: '2025-01', 코드: '1079' },
      { 직종: '송전활선전공', 단가: 662709, 기준일: '2025-01', 코드: '1080' },
      { 직종: '배전전공', 단가: 408559, 기준일: '2025-01', 코드: '1081' },
      { 직종: '배전활선전공', 단가: 557881, 기준일: '2025-01', 코드: '1082' },
      { 직종: '플랜트전공', 단가: 266062, 기준일: '2025-01', 코드: '1083' },
      { 직종: '계장공', 단가: 315484, 기준일: '2025-01', 코드: '1084' },
      { 직종: '철도신호공', 단가: 297049, 기준일: '2025-01', 코드: '1085' },
      { 직종: '통신내선공', 단가: 278565, 기준일: '2025-01', 코드: '1086' },
      { 직종: '통신설비공', 단가: 308930, 기준일: '2025-01', 코드: '1087' },
      { 직종: '통신외선공', 단가: 405235, 기준일: '2025-01', 코드: '1088' },
      { 직종: '통신케이블공', 단가: 433400, 기준일: '2025-01', 코드: '1089' },
      { 직종: '무선안테나공', 단가: 350908, 기준일: '2025-01', 코드: '1090' },
      { 직종: '석면해체공', 단가: 203923, 기준일: '2025-01', 코드: '1091' }
    ];

    // 2024년 데이터 (샘플)
    const wageData2024 = [
      { 직종: '작업반장', 단가: 210000, 기준일: '2024-02', 코드: '1001' },
      { 직종: '보통인부', 단가: 167000, 기준일: '2024-02', 코드: '1002' },
      { 직종: '특별인부', 단가: 218000, 기준일: '2024-02', 코드: '1003' },
      { 직종: '조력공', 단가: 177000, 기준일: '2024-02', 코드: '1004' },
      { 직종: '제도사', 단가: 228000, 기준일: '2024-02', 코드: '1005' },
      { 직종: '비계공', 단가: 275000, 기준일: '2024-02', 코드: '1006' },
      { 직종: '형틀목공', 단가: 268000, 기준일: '2024-02', 코드: '1007' },
      { 직종: '철근공', 단가: 260000, 기준일: '2024-02', 코드: '1008' },
      { 직종: '철공', 단가: 234000, 기준일: '2024-02', 코드: '1009' },
      { 직종: '철판공', 단가: 216000, 기준일: '2024-02', 코드: '1010' },
      { 직종: '철골공', 단가: 246000, 기준일: '2024-02', 코드: '1011' },
      { 직종: '용접공', 단가: 274000, 기준일: '2024-02', 코드: '1012' },
      { 직종: '콘크리트공', 단가: 262000, 기준일: '2024-02', 코드: '1013' },
      { 직종: '건축목공', 단가: 273000, 기준일: '2024-02', 코드: '1023' },
      { 직종: '미장공', 단가: 268000, 기준일: '2024-02', 코드: '1027' },
      { 직종: '타일공', 단가: 280000, 기준일: '2024-02', 코드: '1028' },
      { 직종: '도장공', 단가: 249000, 기준일: '2024-02', 코드: '1029' },
      { 직종: '배관공', 단가: 234000, 기준일: '2024-02', 코드: '1039' },
      { 직종: '내선전공', 단가: 264000, 기준일: '2024-02', 코드: '1075' },
      { 직종: '플랜트배관공', 단가: 318000, 기준일: '2024-02', 코드: '1056' }
    ];

    // 모든 데이터 합치기
    let allData = [...wageData2025_2, ...wageData2025_1, ...wageData2024];

    // 년도별 필터링
    const selectedYear = params.년도 || '2025';
    let filteredData = allData;
    
    if (selectedYear !== '전체') {
      filteredData = allData.filter(item => item.기준일.startsWith(selectedYear));
    }

    // 직종 필터링
    if (params.직종) {
      filteredData = filteredData.filter(item => 
        item.직종.toLowerCase().includes(params.직종!.toLowerCase())
      );
    }

    // 기준일 표기 개선 (2025-01: 상반기, 2025-02: 하반기)
    const formatPeriod = (date: string) => {
      const [year, month] = date.split('-');
      const period = month === '01' ? '상반기' : '하반기';
      return `${year}년 ${period}`;
    };

    // 지역은 현재 전국 단일 데이터이므로 모든 항목에 '전국' 추가
    return filteredData.map(item => ({
      직종: item.직종,
      지역: '전국',
      단가: item.단가,
      기준일: formatPeriod(item.기준일)
    }));
  }
};
